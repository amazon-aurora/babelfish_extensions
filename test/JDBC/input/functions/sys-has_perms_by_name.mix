-- tsql
DROP VIEW IF EXISTS v_perms_by_name;
GO

DROP TABLE IF EXISTS t_perms_by_name;
GO

CREATE TABLE t_perms_by_name (c1 INT, c2 VARCHAR(16));
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO

-- non-existing table
SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_namet2','OBJECT', 'UPDATE');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('t_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('t_perms_by_name','OBJECT', 'UPDATE');
GO

-- non-existing table
SELECT * from sys.HAS_PERMS_BY_NAME('t_perms_by_namet2','OBJECT', 'UPDATE');
GO

-- invalid table spec (four part name or more)
SELECT * from sys.HAS_PERMS_BY_NAME('server.master.dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO

CREATE VIEW v_perms_by_name AS
	SELECT * from t_perms_by_name;
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('v_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('v_perms_by_name','OBJECT', 'UPDATE');
GO

-- don't have permission
-- psql
REVOKE SELECT ON master_dbo.t_perms_by_name FROM master_dbo;
GO

-- tsql
SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO

-- psql
REVOKE SELECT ON master_dbo.v_perms_by_name FROM master_dbo;
GO

-- tsql
SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO

-- psql
GRANT SELECT ON master_dbo.t_perms_by_name TO master_dbo;
GRANT SELECT ON master_dbo.v_perms_by_name TO master_dbo;
GO

-- tsql
SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'SELECT');
GO

SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'SELECT');
GO

DROP VIEW IF EXISTS v_perms_by_name;
GO

DROP TABLE IF EXISTS t_perms_by_name;
GO

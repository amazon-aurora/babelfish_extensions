-- tsql
CREATE LOGIN r1 WITH password = '123';
GO

-- psql
-- Dropping login from psql port should fail
DROP ROLE r1;
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: Babelfish-created login cannot be dropped or altered outside of a Babelfish session
    Server SQLState: 55006)~~


-- Create a non babelfish role that is a member of master_guest
-- and enable dropping
CREATE ROLE r2 IN ROLE master_guest, tempdb_guest, msdb_guest;
GO

DROP ROLE r2;
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: Babelfish-created login cannot be dropped or altered outside of a Babelfish session
    Server SQLState: 55006)~~


SET enable_drop_babelfish_role = true;
GO

DROP ROLE r2;
GO

SET enable_drop_babelfish_role = false;
GO

CREATE ROLE r3;
GO

GRANT master_guest TO r3;
GRANT tempdb_guest TO r3;
GRANT msdb_guest TO r3;
GO

DROP ROLE r3;
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: Babelfish-created login cannot be dropped or altered outside of a Babelfish session
    Server SQLState: 55006)~~


SET enable_drop_babelfish_role = true;
GO

DROP ROLE r3;
GO

SET enable_drop_babelfish_role = false;
GO

-- Test a regular role
CREATE ROLE r4;
GO

DROP ROLE r4;
GO

-- tsql
DROP LOGIN r1;
GO

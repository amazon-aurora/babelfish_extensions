-- tsql
DROP VIEW IF EXISTS v_perms_by_name;
GO

DROP TABLE IF EXISTS t_perms_by_name;
GO

CREATE TABLE t_perms_by_name (c1 INT, c2 VARCHAR(16));
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


-- non-existing table
SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_namet2','OBJECT', 'UPDATE');
GO
~~START~~
int
<NULL>
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('t_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('t_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


-- non-existing table
SELECT * from sys.HAS_PERMS_BY_NAME('t_perms_by_namet2','OBJECT', 'UPDATE');
GO
~~START~~
int
<NULL>
~~END~~


-- invalid table spec (four part name or more)
SELECT * from sys.HAS_PERMS_BY_NAME('server.master.dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
<NULL>
~~END~~


CREATE VIEW v_perms_by_name AS
	SELECT * from t_perms_by_name;
GO

SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('v_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('v_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


-- psql
-- don't have permission
REVOKE SELECT ON master_dbo.t_perms_by_name FROM master_dbo;
GO

-- tsql
SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
0
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
0
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


-- psql
REVOKE SELECT ON master_dbo.v_perms_by_name FROM master_dbo;
GO

-- tsql
SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
0
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
0
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'UPDATE');
GO
~~START~~
int
1
~~END~~


-- psql
GRANT SELECT ON master_dbo.t_perms_by_name TO master_dbo;
GRANT SELECT ON master_dbo.v_perms_by_name TO master_dbo;
GO

-- tsql
SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.t_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.t_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('master.dbo.v_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


SELECT * from sys.HAS_PERMS_BY_NAME('dbo.v_perms_by_name','OBJECT', 'SELECT');
GO
~~START~~
int
1
~~END~~


DROP VIEW IF EXISTS v_perms_by_name;
GO

DROP TABLE IF EXISTS t_perms_by_name;
GO

CREATE LOGIN test1 WITH PASSWORD = 'abc';
GO

CREATE LOGIN test2 WITH PASSWORD = 'abc';
GO

CREATE LOGIN test3 WITH PASSWORD = 'abc';
GO

CREATE LOGIN test4 WITH PASSWORD = 'abc';
GO

SELECT DB_NAME();
GO
~~START~~
nvarchar
master
~~END~~


-- Check for default users
CREATE DATABASE db1;
GO

SELECT rolname, login_name, orig_username, database_name, default_schema_name
FROM sys.babelfish_authid_user_ext
ORDER BY rolname;
GO
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar#!#nvarchar
db_owner#!##!#db_owner#!#db1#!#
dbo#!##!#dbo#!#db1#!#dbo
master_db_owner#!##!#db_owner#!#master#!#
master_dbo#!##!#dbo#!#master#!#master_dbo
master_guest#!##!#guest#!#master#!#
tempdb_db_owner#!##!#db_owner#!#tempdb#!#
tempdb_dbo#!##!#dbo#!#tempdb#!#tempdb_dbo
tempdb_guest#!##!#guest#!#tempdb#!#
~~END~~


SELECT name, default_schema_name
FROM sys.database_principals
ORDER BY default_schema_name DESC, name;
GO
~~START~~
nvarchar#!#nvarchar
dbo#!#master_dbo
db_owner#!#
guest#!#
~~END~~


SELECT rolname, rolcreaterole FROM pg_roles
WHERE rolname LIKE '%dbo'
ORDER BY rolname;
GO
~~START~~
varchar#!#bit
dbo#!#1
master_dbo#!#1
tempdb_dbo#!#1
~~END~~


-- Test default create user
CREATE USER test1;
GO

SELECT rolname, login_name, orig_username, database_name, default_schema_name
FROM sys.babelfish_authid_user_ext
WHERE orig_username = 'test1';
GO
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar#!#nvarchar
master_test1#!#test1#!#test1#!#master#!#dbo
~~END~~


SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'test1';
GO
~~START~~
nvarchar#!#nvarchar
test1#!#dbo
~~END~~


-- Test create user with login uniqueness in the database
CREATE USER test2 FOR LOGIN test2;
GO

CREATE USER test3 FOR LOGIN test2;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Existing user already maps to login 'test2' in current database.)~~


SELECT rolname, login_name, orig_username, database_name, default_schema_name
FROM sys.babelfish_authid_user_ext
WHERE orig_username = 'test2';
GO
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar#!#nvarchar
master_test2#!#test2#!#test2#!#master#!#dbo
~~END~~


SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'test2';
GO
~~START~~
nvarchar#!#nvarchar
test2#!#dbo
~~END~~


-- Test create user with schema option
CREATE SCHEMA sch3;
GO

CREATE USER test3 WITH DEFAULT_SCHEMA = fake_schema;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: The schema 'fake_schema' does not exist.)~~


CREATE USER test3 WITH DEFAULT_SCHEMA = sch3;
GO

SELECT rolname, login_name, orig_username, database_name, default_schema_name
FROM sys.babelfish_authid_user_ext
WHERE orig_username = 'test3';
GO
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar#!#nvarchar
master_test3#!#test3#!#test3#!#master#!#sch3
~~END~~


SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'test3';
GO
~~START~~
nvarchar#!#nvarchar
test3#!#sch3
~~END~~


-- Test create user with invalid login
CREATE USER test4 FOR LOGIN fake_login WITH DEFAULT_SCHEMA = dbo;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: role "fake_login" does not exist)~~


-- Test with long name
-- 65 character length name
CREATE USER AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
FOR LOGIN test4;
GO

SELECT rolname, login_name, orig_username, database_name, default_schema_name
FROM sys.babelfish_authid_user_ext
WHERE orig_username = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
GO
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar#!#nvarchar
master_aaaaaaaaaaaaaaaaaaaaaaaac0168b98fb7152e447c9b9e9ad6f31dd#!#test4#!#AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA#!#master#!#dbo
~~END~~


SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
GO
~~START~~
nvarchar#!#nvarchar
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA#!#dbo
~~END~~


-- Clean up
DROP USER test1;
GO

SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'test1';
GO
~~START~~
nvarchar#!#nvarchar
~~END~~


DROP USER IF EXISTS test2;
GO

SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'test2';
GO
~~START~~
nvarchar#!#nvarchar
~~END~~


DROP USER test3;
GO

SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'test3';
GO
~~START~~
nvarchar#!#nvarchar
~~END~~


DROP USER AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA;
GO

SELECT name, default_schema_name
FROM sys.database_principals
WHERE name = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
GO
~~START~~
nvarchar#!#nvarchar
~~END~~


DROP SCHEMA sch3;
GO

DROP LOGIN test1;
GO

DROP LOGIN test2;
GO

DROP LOGIN test3;
GO

DROP LOGIN test4;
GO

DROP DATABASE db1;
GO
